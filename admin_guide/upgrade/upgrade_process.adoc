== Upgrade Prisma Cloud

You can upgrade Prisma Cloud without losing any of your data or configurations.
Upgrade Console first.
After upgrading Console, upgrade your Defenders, and other Prisma Cloud components.

IMPORTANT: Before upgrading, check the *Breaking changes* section in the release notes to see if there are any special instructions or requirements.

ifdef::compute_edition[]
You can upgrade from an immediate previous major version only.
If your installation is more than one major release behind, you must upgrade in steps.
For example, you cannot directly upgrade from version 18.11 to 19.07.
You must upgrade from version 18.11 to 19.03, and then from 19.03 to 19.07.

Console notifies you when new versions of Prisma Cloud are available.
Notifications are displayed in the top right corner of the dashboard.

image::update_bell.png[width=800]

When you upgrade Console, the old Console container is completely replaced with a new container.
Because Prisma Cloud stores state information outside of the container, all your rules and settings are immediately available to the upgraded Prisma Cloud containers.

Prisma Cloud state information is stored in a database in the location specified by DATA_FOLDER, which is defined in _twistlock.cfg_.
By default, the database is located in _/var/lib/twistlock_.
endif::compute_edition[]

ifdef::prisma_cloud[]
Palo Alto Networks releases new versions of Prisma Cloud on a regular basis.
When a new release is available, a banner is displayed at the top of Compute Console UI, with a link to trigger the upgrade process.
Click the link to upgrade Console.

image::update_saas_console.png[width=800]

By default, Compute Console will upgrade all your Defenders for you.
If you disable automatic Defender upgrades, you must manually upgrade them yourself.
Log into Console and go to *Manage > Defenders > Manage* to see a list of all your deployed Defenders.
endif::prisma_cloud[]

=== Overview of the upgrade process

First upgrade Console.
Next, upgrade your Defenders.
Finally, upgrade all other Prisma Cloud components, such as the Jenkins plugin.
The upgrade process is vastly simplified when automatic Defender upgrades is enabled (it's enabled by default).

The steps in the upgrade process are:

. Upgrade Console.

. Upgrade all deployed Defenders.
+
* If Defender auto-upgrade is enabled --
Console will upgrade deployed Defenders for you.
If Console fails to upgrade one or more Defenders, it displays a banner at the top of the UI.
If you've created an alert for Defender health events, Console emits a message on the alert channel for any Defender it fails to upgrade.
Manually upgrade any Defenders that Console could not auto-upgrade.
+
* If Defender auto-upgrade is disabled --
Manually upgrade all deployed Defenders.

. Validate that all deployed Defenders have been upgraded.

.. Review deployed Defenders and DaemonSets under *Manage > Defenders > Manage*.

.. Filter the the *Status* column by *Upgrade*.

.. If any Defenders have the *Upgrade* status, manually upgrade them.

. Manually upgrade all other Prisma Cloud Compute components, such as the Jenkins plugin, so that their versions exactly match Console's version.


=== Version numbers of installed components

The currently installed version of Console is displayed in the bell menu.

image::upgrade_compute_version.png[width=400]

The versions of your deployed Defenders are listed under *Manage > Defenders > Manage*:

image::upgrade_defender_version.png[width=800]


==== Prisma Cloud Compute components

The versions of all deployed components should match exactly.
To support the multi-step upgrade process, older versions of Prisma Cloud components can continue to interoperate with newer versions of Console in a limited way.
Plan to upgrade all Prisma Cloud components as soon as possible.

After you upgrade Console, upgrade the following components:

* Defenders.
Console can automatically upgrade most Defender types for you.
App-embedded Defenders and PCF Defenders (also known as Twistlock for Pivotal Platform) must be manually upgraded.
* Jenkins plugin.
* twistcli.
ifdef::compute_edition[]
* If you're using xref:../deployment_patterns/projects.adoc[projects], supervisor Consoles must match the Central Console version.
endif::compute_edition[]


==== Version mismatches

Console interoperates with older components on a best-effort basis.
When older components interact with Console, Console displays some indicators in the dashboard:

* In *Monitor > Events*, any audits generated by older Defenders are marked with an out-of-date indicator.
Links to the rules that triggered the audit are disabled (explanation follows).
* In *Monitor > Vulnerabilities* and *Monitor > Compliance*, any scan reports generated by older components (Defender registry scanners, Jenkins plugins, twistcli) are marked with an out-of-date indicator.

Although older Defenders can interoperate with newer Consoles, their operation is restricted.
Older Defenders fully protect your nodes using the policies and settings most recently cached before upgrading Console.
They can emit audits to Console and local logs, including syslog.
However, they cannot access any API endpoint other than the upgrade endpoint, and they cannot share any new data with Console.
No new policies or settings can be pushed from Console to older Defenders.
When Defender is in this state, its status is shown as 'Upgrade needed' in *Manage > Defenders > Manage*.
To restore older Defenders to a fully operation state, upgrade them so that their versions match Console's version.


ifdef::compute_edition[]
=== Upgrading Console when using projects

When you have one or more xref:../deployment_patterns/projects.adoc[tenant or scale Projects], upgrade all Supervisors before upgrading the Central Console.  During the upgrade process, there may be periods where the Supervisors appear as disconnected.  This is normal, because the Supervisors are disconnected while the upgrade is occuring and Central Console will recheck connectivity every 10 minutes.  Within 10 minutes of upgrading all Supervisors and the Central Console, all Supervisors should appear healthy.

Upgrade each Supervisor and then the Central Console using the appropriate procedure:

* xref:upgrade_onebox.adoc[Console - Onebox]
* xref:upgrade_kubernetes.adoc[Console - Kubernetes]
* xref:upgrade_openshift.adoc[Console - Open Shift]
* xref:upgrade_helm.adoc[Console - Helm]
* xref:upgrade_swarm.adoc[Console - Docker Swarm]
* xref:upgrade_amazon_ecs.adoc[Console - Amazon ECS]

endif::compute_edition[]


ifdef::compute_edition[]
[.task]
=== Upgrading Console when using Prisma Cloud HA

If Console is deployed in a xref:../configure/high_availability.adoc[High Availability set], remove Console from all secondary nodes, upgrade Console on the primary node, then redeploy Console to all secondary nodes.

[.procedure]
. Open Console.

. Go to *Manage > System > High Availability* to see a list of all HA nodes.

. Delete all secondary nodes using the 'X' button.

. SSH to each secondary node and completely remove Prisma Cloud using _twistlock.sh_
Typically, these instances will still have a copy of _twistlock.sh_ from the inital install.
If not, download the xref:../welcome/releases.adoc[release] to the node to get a copy.
+
To remove Console, run the following command:

  sudo ./twistlock.sh -u

. Upgrade the primary Console using the steps in xref:upgrade_onebox.adoc[Console - Onebox].

. Follow the guide for xref:../configure/high_availability.adoc#setting-up-twistlock-ha[installing secondary High Availability nodes] starting at step 2.

endif::compute_edition[]


=== Defender auto-upgrade support

Most Defender types can be auto-upgraded.
A handful must still be manaully upgraded.
The following table summarizes the Defender types, and which ones can be auto-upgraded.

[cols="75%a,25%", options="header"]
|===
|Defender type
|Auto-upgrade

|Container Defender, which includes:

* Single Container Defenders
* Cluster Container Defenders
** DaemonSets (Kubernetes, OpenShift)
** Swarm global service
** DC/OS app
|Y

|Serverless Defender
|Y* (see Serverless Dedender auto-protect)

|App embedded Defender
|N

|PCF Defender
|N

|Host Defender
|Y

|===


[.task]
=== Enabling Defender auto-upgrade

By default, Defender auto-upgrade is enabled.
You can check and change the setting in Console.

[.procedure]
. Open Prisma Cloud Compute Console.

. Go to *Manage > Defenders > Manage*.

. Click on *Advanced Settings*.

. Set *Automatically upgrade Defenders* to *On* or *Off*.
+
image::auto_upgrade_defenders.png[width=500]
