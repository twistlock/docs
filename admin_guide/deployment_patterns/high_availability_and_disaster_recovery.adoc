== High Availability and disaster recovery guidelines

The following article describes the key guidelines for keeping your Prisma Cloud Compute deployment highly available, and creating a disaster recovery process.

Prisma Cloud Compute deployment consists of two components - Console and Defenders. 

* Console is the management interface.
It lets you define policy and monitor your environment. 
* Defenders are spread across your environment and protect its workloads according to the policies set in the Console.

When the Console fails or stops working, your environment still has active runtime protection done by the defenders. Each defender holds the updated policies, and keeps protecting your workloads according to them.

This article mainly focuses on Prisma Cloud Compute Edition deployment (self-hosted console). When leveraging Prisma Cloud Enterprise Edition (SaaS Console), high availability for the console is automatically provided by Palo Alto Networks. 

=== Guidelines

Follow the procedure below to create high availability and disaster recovery processes for your deployment:

[.procedure]
. *Inside each cluster*
+
Whether your deployment is in the cloud or on-premise, the various orchestrators (such as Kubernetes, OpenShift, ECS, etc.) automatically support HA of the cluster and the containers running on it.

.. Console - set your storage to be external to the Console container/node. In case the Console container/node fails, it comes back up by the orchestrator, connects to the external storage, and keeps using it to get its updated state.
.. Defenders - defenders are deployed as a daemonset. In case of a node failure, the orchestrator automatically brings up another node and sets a Defender container on it, as a part of the daemonset definition.

. *Between clusters*
+
Prisma Cloud Compute supports every HA and DR solution designed for all the applications you have in the environment. In the lower layers for storage, and in the upper layers for networking and load balancing.

.. *Public Clouds*
... *Inside each region* - CSPs provide high availability using availability zones inside each region. In case of an AZ failure, most cloud providers bring the cluster back up in another AZ. 
+
Use cross availability zones storage solutions, so when the cluster is up in another AZ, it connects to the shared storage and keeps functioning as before. For example, in AWS, EFS can be used as a shared storage between availability zones.
... *Between regions* - CSPs provide solutions such as snapshots and backups that can be moved between regions, shared storage between regions, etc. You can also use <<Prisma Cloud Compute backup & restore>> capabilities for moving the data between regions.

.. *Private Cloud (On premise)*
... *Inside each site/data center* (between clusters on the same site)
.... Use shared storage between the clusters
.... Create a disaster recovery process using <<Prisma Cloud Compute backup & restore>> capabilities:
..... Create a spare cluster (warm or cold) with PCC deployment
..... Backup PCC’s data periodically to a location outside of the active cluster
..... If the active cluster fails, bring the spare cluster up, and restore PCC’s data to it

... *Between sites/data centers* 
.... Create a disaster recovery process for cases where one site goes down, using <<Prisma Cloud Compute backup & restore>> capabilities:
..... Create a spare site (warm or cold) with PCC deployment
..... Backup PCC’s data periodically to a location outside of the active site
..... If the entire active site fails, bring the spare site up, and  restore PCC’s data from the external location to it

image::ha_dr_flow_chart.png[width=800]

=== Projects 

xref:../deployment_patterns/projects.adoc[Projects] solve the problem of multi-tenancy. Each project consists of a Console and its Defenders. Each project is a separate, compartmentalized environment which operates independently with its own rules and configurations.

Therefore, high availability and disaster recovery processes should be created for each tenant project, similar to the way a single console deployment would be handled. In case of using <<Prisma Cloud Compute backup & restore>> capabilities, backups should be created and restored separately for each project.

=== Prisma Cloud Compute backup & restore

Prisma Cloud disaster recovery automatically backs up all data and configuration files periodically.
You can view all backups, make new backups, and restore specific backups from the Console UI.
You can also restore specific backups using the twistcli command line utility.

Prisma Cloud is implemented with containers that cleanly separate the application from its state and configuration data.
To back up a Prisma Cloud installation, only the files in the data directory need to be archived.
Because Prisma Cloud containers read their state from the files in the data directory, Prisma Cloud containers do not need to be backed up, and they can be installed and restarted from scratch.

When data recovery is enabled (default), Prisma Cloud archives its data files periodically and copies the backup file to a location you specify.
The default path to the data directory is _/var/lib/twistlock_.
You can specify a different path to the data directory in _twistlock.cfg_ when you install Console.

[.task]
==== Configuring automated backups

By default, automated backups are enabled.
With automated backups enabled, Prisma Cloud takes a daily, weekly, and monthly snapshots.
These are known as system backups.

To specify a different backup directory or to disable automated backups, modify _twistlock.cfg_ and install (or reinstall) Prisma Cloud Console.
The following configuration options are available:

[cols="25%,75%a", options="header"]
|===
|Configuration option
|Description

|`DATA_RECOVERY_ENABLED`
|Enables or disables automated backups.

* `true` -- Enables automated backups (default).
* `false` -- Disables automated backups.

|`DATA_RECOVERY_VOLUME`
|Specifies the directory where backups are saved.

For example, archives could be saved on durable persistent storage, such as a volume from Amazon Elastic Block Storage (EBS).

The default value is _/var/lib/twistlock-backup_.
|===

[.procedure]
. Open _twistlock.cfg_ for editing.

. Scroll down to the Data recovery section.

. Enable (or disable) automated back up by setting DATA_RECOVERY_ENABLED to true (or false).
+
  DATA_RECOVERY_ENABLED=true

. Specify the location where backups should be stored.
+
  DATA_RECOVERY_VOLUME=</PATH/TO/BACKUP/VOLUME>

. Load your new configuration settings.
+
If you have not installed Prisma Cloud Console yet, follow the regular installation procedure.
For more information, see xref:../install/getting_started.adoc[Install Prisma Cloud].
+
If Prisma Cloud has already been installed on your host, load your new _twistlock.cfg_ file by re-running _twistlock.sh_.
The following command assumes that _twistlock.sh_ and your updated _twistlock.cfg_ reside in the same directory.
+
  $ sudo ./twistlock.sh console

[.task]
==== Making manual backups

Prisma Cloud automatically creates and maintains daily, weekly, and monthly backups.
These are known as system backups.
You can also make your own backups at any point in time.
These are known as manual backups.

[.procedure]
. Open Console.

. Go to *Manage > System > Backup & Restore*.

. Under *Manual backups*, click *Create backup*.

. Give your backup a name, then click *Create*.
+
Your backup file is stored in _/var/lib/twistlock-backup_ in the storage volume allocated to Prisma Cloud Console.
For a onebox installation, this would simply be the local file system of the host where Console runs.
For a cluster, such as Kubernetes, this would be the persistent volume allocated to the Console service.

[.task]
==== Restoring backups from the Console UI

You can restore Console from a backup file directly from within the Console UI.
The Console UI lists all available backups.

NOTE: You can only restore Console from a backup file whose version exactly matches the current running version of Console.
Therefore, if the current running version of Console is 19.11.512, you cannot restore a backup whose version is 19.11.506.
To restore a different version of Console, install the Prisma Cloud version that matches your backup version, then follow the procedure here to restore that backup.
As long as the specified backup directory (by default, _/var/lib/twistlock-backup_) contains your backup file, you'll be able to restore it.

[.procedure]
. Open Console.

. Go to *Manage > System > Backup & Restore*.

. Click *Restore* on one of the system or manual backups.

. After the database is reloaded from the backup file, restart Console.
+
For a onebox installation, ssh to the host where Console runs, then run the following command:
+
  $ docker restart twistlock_console
+
For a Kubernetes installation, delete the Console pod, and the replication controller will automatically restart it:
+
[source,bash]
----
// Get the name of Prisma Cloud Console pod:
$ kubectl get po -n twistlock | grep console

// Delete the Prisma Cloud Console pod:
$ kubectl delete po <TWISTLOCK_CONSOLE> -n twistlock
----
+
NOTE: If any new Defenders were installed since the backup was created, restart those Defenders.
Otherwise, they might not function properly.
+
NOTE: If a Defender created any new runtime models since the backup was created, restart those Defenders.
Otherwise, those models might not be visible.


[.task]
==== Restoring backups from twistcli

You can restore Console from a backup using _twistcli_.
Use this restore flow when Console is unresponsive and you cannot access the UI to force a restore to a known good state.

NOTE: You can only restore Console from a backup file whose version exactly matches the current running version of Console.
Therefore, if the current running version of Console is 2.5.88, you cannot restore a backup whose version is 2.5.50.
To restore a different version of Console, install the Prisma Cloud version that matches your backup version, then follow the procedure here to restore that backup.
As long as the specified backup directory (by default, _/var/lib/twistlock-backup_) contains your backup file, you'll be able to restore it.

*Prerequisites:*

* Your host can access the volume where the Prisma Cloud backups are stored.
By default, backups are stored in _/var/lib/twistlock-backup_, although this path might have been customized at install time.

* Your host can access the Prisma Cloud's data volume.
By default, the data volume is located in _/var/lib/twistlock_, although this path might have been customized at install time.

* Your version of _twistcli_ matches the version of the backup you want to restore.

[.procedure]
. Go to the directory where you unpacked the Prisma Cloud release.

. Run the _twistcli restore_ command.
Run _twistcli restore --help_ to see all arguments.

.. List all available backups.
To list all files in the default backup folder (/var/lib/twistlock-backup), run _twistcli restore_ without any arguments:
+
  $ ./twistcli restore
+
To list all backup files in a specific location, run:
+
  $ ./twistcli restore <PATH/TO/FOLDER>

.. Choose a file to restore by entering the number that corresponds with the backup file.
+
For example:
+
```
aqsa@aqsa-faith: ./twistcli restore --data-recovery-folder /var/lib/twistlock-backup/
Please select from the following:
0: backup1      2.5.91  2018-08-07 15:10:10 +0000 UTC
1: daily        2.5.91  2018-08-06 16:10:48 +0000 UTC
2: monthly      2.5.91  2018-08-06 16:10:48 +0000 UTC
3: weekly       2.5.91  2018-08-06 16:10:48 +0000 UTC
Please enter your selection:
0
```
. After the database is reloaded from the backup file, re-install/restart Console.
+
For a onebox installation, ssh to the host where Console runs, then rerun the installer:
+
  $ sudo ./twistlock.sh -ys onebox
+
For a Kubernetes installation, delete the Console pod, and the replication controller will automatically restart it:
+
[source,bash]
----
// Get the name of Prisma Cloud Console pod:
$ kubectl get po -n twistlock | grep console

// Delete the Prisma Cloud Console pod:
$ kubectl delete po <TWISTLOCK_CONSOLE> -n twistlock
----
+
NOTE: If any new Defenders were installed since the backup was created, restart those Defenders.
Otherwise, they might not function properly.
+
NOTE: If a Defender created any new runtime models since the backup was created, restart those Defenders.
Otherwise, those models might not be visible.


==== Downloading backup files

Prisma Cloud Compute lets you download backup files so that they can be copied to another location. Backup files can be downloaded from the Console - Go to *Manage > System > Backup & Restore*, and click *Actions > Export* to download a backup.
