== Serverless function scanning

Prisma Cloud can scan serverless functions for vulnerabilities.
Prisma Cloud supports AWS Lambda, Google Cloud Functions, and Azure Functions.

Serverless computing is an execution model in which a cloud provider dynamically manages the allocation of machine resources and schedules the execution of functions provided by users.
Serverless architectures delegate the operational responsibilities, along with many security concerns, to the cloud provider.
This new model raises
https://www.twistlock.com/2017/12/19/introduction-serverless-security-part-1/[new security concerns],
while some familiar old concerns still apply.
In particular, your app itself is still prone to attack.
The vulnerabilities in your code and associated dependencies are the footholds attackers use to compromise an app.
Prisma Cloud can show you a function's dependencies, and surface the vulnerabilities in those dependent components.


[.section]
=== Capabilities

For serverless, Prisma Cloud can scan Node.js, Python, and Java packages.
There is currently no support for AWS or Azure C# functions.

Prisma Cloud scans are triggered by the following events:

* When the settings change, including when new functions are added for scanning.
* When you explicitly click the *Scan* button in the *Monitor > Vulnerabilities > Functions* page.
* Periodically.
By default, Prisma Cloud rescans serverless functions every 24 hours, but you can configure a custom interval in *Manage > System > Scan*.


[.task]
=== Scanning a serverless function

Configure Prisma Cloud to periodically scan your serverless functions.
Unlike image scanning, all function scanning is handled by Console.

[.procedure]
. Open Console.

. Go to *Defend > Vulnerabilities > Functions*.

. Click *Add serverless account*.

. In the dialog, enter the following settings:

.. In *Provider*, select your cloud platform.

.. Specify a Region.

.. Specify a function name.
+
Wildcards are supported.
See the table at the top of the page for the supported syntax and examples.

.. Select or xref:../configure/credentials_store.adoc#[create credentials] so that Prisma Cloud can access your account.
+
* AWS -- Specify either an IAM user credential (access key ID and secret access key) or IAM role.
* Google -- Specify a service key.
* Azure -- Specify a user access token.

.. Specify a cap for the number of functions to scan.
+
Prisma Cloud scans the X most recent functions, where X is the cap value.

.. Click *Add*.

. Click the yellow save button.
+
image::save_button.png[width=50]

. View the scan report.
Go to *Monitor > Vulnerabilities > Functions*.



=== Authenticating with AWS

The serverless scanner is implemented as part of Console.
The scanner requires the *AWSLambdaReadOnlyAccess* permissions policy.

If authenticating with an IAM user, use the Security Token Service (STS) to temporarily issue security credentials to Prisma Cloud to scan your Lambda functions.
AWS STS is considered a best practice per the AWS Well-Architected Framework.
For more on how to use AWS STS, see xref:../configure/credentials_store.adoc#_aws_security_token_service_sts[here].

When authenticating with an IAM user, Console can access and scan functions across multiple regions.
The following dialog shows Console set up to scan Lambda functions using an IAM user with STS.
The user credentials (access key ID and secret access key) were previously entered in the Prisma Cloud credentials store, and the role with the *AWSLambdaReadOnlyAccess* permissions policy was already created in AWS.

image::serverless_iam_user_with_sts.png[width=500]

The Prisma Cloud serverless scanner can also authenticate with AWS using an IAM role.
If Console authenticates with AWS using an IAM role, it can only scan the functions in the region where the EC2 instance is deployed.
The following dialog shows Console set up to scan Lambda functions using an IAM role:

image::serverless_iam_role.png[width=500]


[.task]
=== Scanning Azure Functions

Azure Functions are architected differently than AWS Lambda and Google Cloud Functions.
Azure function apps can hold multiple functions.
The functions are not segregated from each other.
They share the same file system.
Rather than separately scanning each function in a function app, download the root directory of the function app, which contains all its functions, and scan them as a bundle.

NOTE: Prisma Cloud only scans Linux functions that use *External package URL* as the deployment technology.
For more information, see https://docs.microsoft.com/en-us/azure/azure-functions/functions-deployment-technologies[Deployment technologies in Azure Functions].

To do this, you must know the Region, Name (of the function), and Service Key.
To get the Service Key, download and https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest[install the Azure CLI], then:

[.procedure]
. Log into your account with a user that has the https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles[User Account Administrator] role.

  $ az login

. Get the service key.

 $ az ad sp create-for-rbac --sdk-auth --name twistlock-azure-serverless-scanning --role contributor
+
Sample output from the previous command:
+
  {
    "clientId": "f8e9de2o-45bd-af94-ae11-b9r8c5tfy3b6",
    "clientSecret": "4dfds482-6sdd-4dsb-b5ff-56123043c4dc",
    "subscriptionId": "ea19322m-z2bd-501c-dd11-234m547a944e",
    "tenantId": "c189c61a-6c27-41c3-9949-ca5c8cc4a624",
    "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
    "resourceManagerEndpointUrl": "https://management.azure.com/",
    "activeDirectoryGraphResourceId": "https://graph.windows.net/",
    "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
    "galleryEndpointUrl": "https://gallery.azure.com/",
    "managementEndpointUrl": "https://management.core.windows.net/"
  }

. Copy the JSON output, which is your secret key, and paste it into the *Service Key* field for your Azure credentials in Prisma Cloud Console.


=== Scanning functions with twistcli

You can also use the `twistcli` command line utility to scan your serverless functions.
First download your serverless function as a ZIP file, then run:
 
  $ twistcli serverless scan <SERVERLESS_FUNCTION.ZIP>
  
To view scan reports in Console, go to *Monitor > Vulnerabilities > Functions > CI* or *Monitor > Compliance > Functions > CI*.

==== Twistcli Options

ifdef::prisma_cloud[]
`--address` [.underline]#`URI`#::
Required.
Complete URI for Console, including the protocol and port.
Only the HTTPS protocol is supported.
+
Example: --address https://https://us-west1.cloud.twistlock.com/us-3-123456789

To get the address for your Console, go to *Compute > Manage > System > Downloads*, and copy the string under *Path to Console*.

`-u`, `--user` [.underline]#`Access Key ID`#::
_Access Key ID_ to access Prisma Cloud. 
If not provided, the `TWISTLOCK_USER` environment variable is used, if defined.
Othewise, "admin" is used as the default.

`-p`, `--password` [.underline]#`Secret Key`#::
_Secret Key_ for the above _Access Key ID_ specified with `-u`, `--user`.
If not specified on the command-line, the `TWISTLOCK_PASSWORD` environment variable is used, if defined.
Otherwise, you will be prompted for the user's password before the scan runs.

_Access Key ID_ and _Secret Key_ are generated from the Prisma Cloud user interface.
For more information, see xref:../authentication/access_keys.adoc[access keys]

endif::prisma_cloud[]


ifdef::compute_edition[]
`--address` [.underline]#`URI`#::
Required.
Complete URI for Console, including the protocol and port.
Only the HTTPS protocol is supported.
By default, Console listens to HTTPS on port 8083, although your administrator can configure Console to listen on a different port.
+
Example: --address https://console.example.com:8083

`-u`, `--user` [.underline]#`USERNAME`#::
Username to access Console.  If not provided, the `TWISTLOCK_USER` environment variable will be used if defined, or "admin" is used as the default.

`-p`, `--password` [.underline]#`PASSWORD`#::
Password for the user specified with `-u`, `--user`.
If not specified on the command-line, the `TWISTLOCK_PASSWORD` environment variable will be used if defined, or otherwise will prompt for the user's password before the scan runs.

`--project` [.underline]#`PROJECT NAME`#::
Interface with a specific supervisor Console to retrieve policy and publish results.
+
Example: --project "Tenant Console"
endif::compute_edition[]

`--details`::
Show all vulnerability details.

`--tlscacert` [.underline]#`PATH`#::
Path to Prisma Cloud CA certificate file.
If no CA certificate is specified, the connection to Console is insecure.

`--include-js-dependencies`::
Include javascript package dependencies.

`--token` [.underline]#`TOKEN`#::
Token to use for Prisma Cloud Console authentication.
Tokens can be retrieved from the API endpoint _api/v1/authenticate_ or from the *Manage > Authenticate > User Certificates* page in Console.

`--cloudformation-template` [.underline]#`PATH`#::
Path to the CloudFormation template file in JSON or YAML format. Prisma Cloud scans the function source code for AWS service APIs being used, compares the APIs being used to the function permissions, and reports when functions have permissions for APIs they don't need.

`--function` [.underline]#`NAME`#::
Function name to be used in policy detection and Console results. When creating policy rules in Console, you can target specific rules to specific functions by function name. If this field is left unspecified, the function zip file name is used.

`--output-used-apis`::
Report APIs used by the function

`--publish`::
Publish the scan result to the Console.  True by default.
