== Configure VM image scanning

Prisma Cloud can scan Linux Amazon Machine Images (AMIs).

The following AMIs aren't supported:

* Images that don't use cloud-init for bootstrapping, such as Red Hat Enterprise Linux CoreOS (CoreOS for OpenShift).
RHCOS uses Ignition.
* Images that use paravirtualization.
* Images that only support old TLS protocols (less than TLS 1.1) for utilities such as curl.
For example, Ubuntu 12.10.
* Encrypted images.


=== Prerequisites

The service account Prisma Cloud uses to scan AMIs must have at least the following policy:
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeSecurityGroups",
                "ec2:CreateSecurityGroup",
                "ec2:RevokeSecurityGroupEgress",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:AuthorizeSecurityGroupEgress",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeImages",
                "ec2:DescribeInstances",
                "ec2:RunInstances",
                "ec2:CreateTags",
                "ec2:TerminateInstances"
            ],
            "Resource": "*"
        }
    ]
}
----

=== Deployment

VM image scanning is handled by the Console. Prisma Cloudâ€™s Console scans a VM image by creating a VM instance which is running the VM image to be scanned.
When you configure Prisma Cloud to scan VM images, you can define the number of scanners to use. Defining more than one scanner means that the Console will create a number of VM instances to scan multiple VM images simultaneously.
For scanning large numbers of VM images, increase the number of scanners to improve throughput and reduce scan time.

If you remove a VM image, or it becomes unavailable, Prisma Cloud maintains the scan results for 30 days.
After 30 days, the scan results are purged.


[.task, #_vm_images_scan_settings]
=== VM images scan settings

[.procedure]
. Open Console.

. Go to *Defend > Vulnerabilities/Compliance > Hosts > VM Images*.

. Click *Add Scope*.
+
Each scope has the following parameters.
+
[cols="15%,85%a", options="header"]
|===
|Field
|Description

|Version
|Specify the type of VM images to scan.
The current supported VM images version is Amazon Machine Image (AMI).

|Console Address
|Specify the Console URL for the scanner VM instance to use.

|Region
|Specify the AWS region to scan.

|VM images
|Specify the names of the VM images to scan. 
This field supports xref:../configure/rule_ordering_pattern_matching.adoc#[pattern matching]. To scan all VM images, simply enter wildcard (`{asterisk}`).

NOTE: When this field contains a wildcard (e.g. Amazo*), only private AMIs are scanned. When using explicit image names, AWS Marketplace and community AMIs are scanned as well.

|Tags
|Specify the AWS tags to scan. 
Use the key-value pattern 'key:value'. This field supports xref:../configure/rule_ordering_pattern_matching.adoc#[pattern matching]. To scan VM images with all AWS tags, simply enter wildcard (`{asterisk}`).

|Excluded VM images
|Specify VM images to exclude from the scan. 
This field supports xref:../configure/rule_ordering_pattern_matching.adoc#[pattern matching].

|Credentials
|Specify the credentials required to access the VM images.
If the credentials have already been created in the Prisma Cloud credential store, select it.
If not, click *Add New*.

|Number of scanners
|Number of AMIs to concurrently scan.
Increase the number of scanners to increase throughput and reduce scan time.

|Cap
|Specify the maximum number of VM images to scan, sorted according to the last modified date. The most recently modified VM image is scanned first, followed by the image next most recently modified, and so on.
To scan all VM images, set CAP to 0.

|===


[.task, #_vm_images_rules]
=== VM images rules

To define which VM images to scan, create a new VM images scan rule.

[.procedure]
. Open Console.

. Go to *Defend > Vulnerabilities/Compliance > Hosts > VM Images*.

. Click *Add Rule*.

. Fill out your policy.

. Click *Save*.


=== Additional scan settings

Additional scan settings can be found under *Manage > System > Scan*, where you can set the xref:../configure/configure_scan_intervals.adoc#[VM images scan interval].
